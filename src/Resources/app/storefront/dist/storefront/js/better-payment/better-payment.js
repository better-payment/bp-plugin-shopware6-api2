(()=>{"use strict";let{PluginBaseClass:e}=window,t=["postalAddress","email","phone"];window.PluginManager.register("ApplePayPlugin",class extends e{init(){this.el.addEventListener("click",this.onClick.bind(this)),this.orderForm=document.getElementById("confirmOrderForm")}showErrorMessage(){let e=document.getElementById("betterpayment-apple-pay-error");e.style.display="block",e.scrollIntoView({block:"start"})}onClick(){if(!this.orderForm.reportValidity())return;let e=this.options.initialData,s=this.options.amount;try{let a={countryCode:e.countryCode,currencyCode:e.currency,merchantCapabilities:e.applePay.merchantCapabilities,supportedNetworks:e.applePay.supportedNetworks,total:{label:e.shopName,amount:s},requiredShippingContactFields:t,requiredBillingContactFields:t},o=new ApplePaySession(14,a);o.onvalidatemerchant=()=>{fetch(this.options.validateMerchantPath,{method:"POST"}).then(e=>e.json()).then(e=>{let t=JSON.parse(atob(e.applepay_payment_session_token));o.completeMerchantValidation(t)}).catch(e=>{this.showErrorMessage()})},o.onpaymentmethodselected=()=>{let t={newTotal:{label:e.shopName,amount:s}};o.completePaymentMethodSelection(t)},o.onpaymentauthorized=async t=>{var a,i,n;let r=this.options.billingAddress,p=this.options.shippingAddress,l={applepay_token:btoa(JSON.stringify((a=t.payment)===null||void 0===a?void 0:a.token)),amount:s,currency:e.currency,postback_url:e.postback_url,shipping_costs:e.shippingCosts,vat:e.vat,order_id:e.orderId,merchant_reference:e.orderId+" - "+e.shopName,customer_id:e.customerId,customer_ip:e.customerIp,app_name:e.appName,app_version:e.appVersion,address:r.street,city:r.city,postal_code:r.zipcode,state:(i=r.countryState)===null||void 0===i?void 0:i.name,country:r.country.iso,first_name:r.firstName,last_name:r.lastName,email:e.email,phone:r.phoneNumber,shipping_address:p.street,shipping_city:p.city,shipping_postal_code:p.zipcode,shipping_state:(n=p.countryState)===null||void 0===n?void 0:n.name,shipping_country:p.country.iso,shipping_first_name:p.firstName,shipping_last_name:p.lastName},c=await fetch(this.options.processPaymentPath,{method:"POST",body:JSON.stringify(l),headers:{"Content-Type":"application/json"}});if(c.ok){let e=await c.json();0===e.error_code?(o.completePayment({status:ApplePaySession.STATUS_SUCCESS}),document.getElementById("betterpayment_apple_pay_transaction_id").value=e.transaction_id,document.getElementById("betterpayment_apple_pay_transaction_status").value=e.status,this.orderForm.submit()):(o.completePayment({status:ApplePaySession.STATUS_FAILURE}),this.showErrorMessage())}else o.completePayment({status:ApplePaySession.STATUS_FAILURE}),this.showErrorMessage()},o.oncancel=e=>{this.showErrorMessage()},o.begin()}catch(e){this.showErrorMessage()}}},"[data-apple-pay-plugin]")})();